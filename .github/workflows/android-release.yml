name: Build Android Release

on:
  # Trigger on release publication
  release:
    types: [published]
  # ALLOWS MANUAL TRIGGER (Very useful for testing!)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup .NET 10 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 2. Install MAUI Workload
      - name: Install MAUI Workload
        run: dotnet workload install maui-android

      # 3. Restore Dependencies
      - name: Restore Dependencies
        run: dotnet restore OpenTracker.sln

      # 4. Decode the Keystore (Using Absolute Path)
      - name: Decode Keystore
        shell: pwsh
        run: |
          $keystorePath = "${{ github.workspace }}\user.keystore"
          $base64 = "${{ secrets.ANDROID_KEYSTORE_BASE64 }}"
          
          if ([string]::IsNullOrWhiteSpace($base64)) {
            Write-Error "ANDROID_KEYSTORE_BASE64 secret is empty!"
            exit 1
          }

          $bytes = [System.Convert]::FromBase64String($base64)
          [IO.File]::WriteAllBytes($keystorePath, $bytes)
          
          Write-Host "Keystore created at: $keystorePath"

      # 5. Build, Sign, and Publish
      # We pass the ABSOLUTE PATH to the keystore so MSBuild cannot get lost
      - name: Build and Sign Android APK
        run: |
          # 1. Determine Version Name from Release Tag
          # If triggered by a release, this holds the tag (e.g., "v1.0.0").
          # If manual dispatch, it falls back to a dev version.
          $versionName = "${{ github.event.release.tag_name }}"
          if ([string]::IsNullOrWhiteSpace($versionName)) {
              $versionName = "1.0.${{ github.run_number }}-dev"
          }
          
          # 2. Determine Version Code (Integer)
          # We use the GitHub Run Number to ensure it always increments.
          $versionCode = "${{ github.run_number }}"

          Write-Host "Building App: VersionName=$versionName, VersionCode=$versionCode"

          dotnet publish OpenTracker/OpenTracker.csproj `
            -f net10.0-android `
            -c Release `
            -p:ApplicationDisplayVersion="$versionName" `
            -p:ApplicationVersion="$versionCode" `
            -p:AndroidPackageFormat=apk `
            -p:AndroidKeyStore=true `
            -p:AndroidSigningKeyStore="${{ github.workspace }}\user.keystore" `
            -p:AndroidSigningKeyAlias="${{ secrets.ANDROID_KEY_ALIAS }}" `
            -p:AndroidSigningStorePass="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" `
            -p:AndroidSigningKeyPass="${{ secrets.ANDROID_KEY_PASSWORD }}" `
            --output ./build_output

      # 6. Upload the APK to the Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release' # Only upload if this was a real release
        with:
          files: |
            ./build_output/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. Upload as Artifact (For manual testing)
      - name: Upload Artifact (Manual Run)
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: OpenTracker-Android
          path: ./build_output/*.apk
