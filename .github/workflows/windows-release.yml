name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workload
        run: dotnet workload install maui-windows maui-android

      - name: Restore Dependencies
        run: dotnet restore OpenTracker.sln

      # Decode the PFX certificate from Secrets
      - name: Decode PFX Certificate
        shell: pwsh
        run: |
          $pfxPath = "${{ github.workspace }}\GitHubActionsWorkflow.pfx"
          $base64 = "${{ secrets.WINDOWS_PFX_BASE64 }}"
          $passwordString = "${{ secrets.WINDOWS_PFX_PASSWORD }}"
          
          if ([string]::IsNullOrWhiteSpace($base64)) { Write-Error "PFX Base64 is empty"; exit 1 }

          # 1. Decode PFX File
          $bytes = [System.Convert]::FromBase64String($base64)
          [IO.File]::WriteAllBytes($pfxPath, $bytes)
          
          # 2. Convert Password to SecureString (Required for Import)
          $securePass = ConvertTo-SecureString -String $passwordString -AsPlainText -Force

          # 3. Import into CurrentUser\My Store
          # This makes the private key accessible to the build process
          $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePass
          
          if (-not $cert) { Write-Error "Certificate import failed"; exit 1 }

          # 4. Set the Thumbprint as an Environment Variable for the next step
          echo "WINDOWS_CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
          
          Write-Host "Successfully Imported Certificate. Thumbprint: $($cert.Thumbprint)"

      # Windows requires versions in Major.Minor.Build.Revision format (e.g., 1.0.15.0)
      - name: Build and Sign Windows MSIX
        run: |
          # 1. Get Tag and strip 'v' (v0.0.10 -> 0.0.10)
          $tagName = "${{ github.event.release.tag_name }}"
          $cleanVersion = $tagName -replace '^v',''
          
          if ([string]::IsNullOrWhiteSpace($cleanVersion)) {
              $cleanVersion = "1.0.0"
          }

          # 2. Create MSIX Version (4 parts required: Major.Minor.Build.Revision)
          # If tag is 0.0.10, we append run_number to make it 0.0.10.45
          # If tag is 1.0, we append .0.run_number -> 1.0.0.45
          $parts = $cleanVersion.Split('.')
          $runNum = "${{ github.run_number }}"
          
          $appDisplayVersion = "$cleanVersion" 

          # 3. ApplicationVersion MUST be an integer (for internal build checks)
          $appVersionInt = $runNum

          Write-Host "Building Windows App: DisplayVersion=$appDisplayVersion, AppVersion=$appVersionInt"
          
          # Define Output Folder
          $outputDir = "${{ github.workspace }}\build_output"

          # 4. Publish
          dotnet publish OpenTracker/OpenTracker.csproj `
            -f net10.0-windows10.0.19041.0 `
            -c Release `
            -p:ApplicationDisplayVersion="$appDisplayVersion" `
            -p:ApplicationVersion="$appVersionInt" `
            -p:WindowsPackageType=MSIX `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateThumbprint="${{ env.WINDOWS_CERT_THUMBPRINT }}" `
            -p:AppxPackageDir="$outputDir" `
            --output "$outputDir"

      # DEBUG: LIST FILES (Helps verify where the file actually landed)
      - name: List Output Files
        run: dir "${{ github.workspace }}\build_output" /s

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            ./build_output/**/*.msix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Manual Run)
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: OpenTracker-Windows
          path: ./build_output/**/*.msix