name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workload
        run: dotnet workload install maui-windows maui-android

      - name: Restore Dependencies
        run: dotnet restore OpenTracker.sln

      # Decode the PFX certificate from Secrets
      - name: Decode PFX Certificate
        shell: pwsh
        run: |
          $pfxPath = "${{ github.workspace }}\GitHubActionsWorkflow.pfx"
          $base64 = "${{ secrets.WINDOWS_PFX_BASE64 }}"
          
          if ([string]::IsNullOrWhiteSpace($base64)) {
            Write-Error "WINDOWS_PFX_BASE64 secret is empty!"
            exit 1
          }

          $bytes = [System.Convert]::FromBase64String($base64)
          [IO.File]::WriteAllBytes($pfxPath, $bytes)
          
          Write-Host "Certificate created at: $pfxPath"

      # Windows requires versions in Major.Minor.Build.Revision format (e.g., 1.0.15.0)
      - name: Build and Sign Windows MSIX
        run: |
          # 1. Determine Version Name (Tag)
          $tagName = "${{ github.event.release.tag_name }}"
          if ([string]::IsNullOrWhiteSpace($tagName)) {
              $tagName = "1.0.0" # Fallback
          }
          # Strip 'v' prefix if present (v1.0 -> 1.0)
          $cleanVersion = $tagName -replace '^v',''

          # 2. Determine Version Code (4-part format required for MSIX)
          # We append the GitHub Run Number as the 3rd or 4th digit to ensure uniqueness
          # Example: If tag is 1.2, result is 1.2.45.0
          $msixVersion = "$cleanVersion.${{ github.run_number }}.0"
          
          # Fix: If the tag already had 3 parts (1.2.3), we just append the run number as revision
          if ($cleanVersion.Split('.').Count -ge 3) {
             $msixVersion = "$cleanVersion.${{ github.run_number }}"
          }

          Write-Host "Building Windows App: DisplayVersion=$tagName, MsixVersion=$msixVersion"

          # 3. Publish
          # We explicitly set WindowsPackageType=MSIX because your csproj defaults to 'None'
          dotnet publish OpenTracker/OpenTracker.csproj `
            -f net10.0-windows10.0.19041.0 `
            -c Release `
            -p:ApplicationDisplayVersion="$tagName" `
            -p:ApplicationVersion="$msixVersion" `
            -p:WindowsPackageType=MSIX `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateKeyFile="${{ github.workspace }}\GitHubActionsWorkflow.pfx" `
            -p:PackageCertificatePassword="${{ secrets.WINDOWS_PFX_PASSWORD }}" `
            --output ./build_output

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            ./build_output/*.msix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Manual Run)
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: OpenTracker-Windows
          path: ./build_output/*.msix